`loveconnect.html`
```html
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LoveConnect - Dating Demo</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap');
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  body, html {
    height: 100%;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #ff6e7f, #bfe9ff);
    color: #333;
  }
  #app-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    max-width: 960px;
    margin: 0 auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    overflow: hidden;
  }
  header {
    background: #fff9fb;
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 2rem;
    color: #e91e63;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    user-select: none;
  }
  header .logo {
    font-style: italic;
    letter-spacing: 3px;
    text-shadow: 1px 1px 5px #ff80ab;
  }
  #main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  /* Tabs */
  #tabs {
    display: flex;
    background: #fce4ec;
    justify-content: center;
    border-bottom: 1px solid #e91e63;
    user-select: none;
  }
  .tab-button {
    padding: 0.8rem 1.5rem;
    border: none;
    cursor: pointer;
    font-weight: 600;
    color: #b71c46;
    background: transparent;
    border-bottom: 3px solid transparent;
    transition: border-color 0.3s ease;
    font-size: 1rem;
  }
  .tab-button.active {
    border-color: #e91e63;
    color: #e91e63;
    background: #fff0f5;
  }
  .tab-button:hover:not(.active) {
    background: #ffd6e5;
  }
  /* Tab panels */
  .tab-panel {
    flex: 1;
    overflow: auto;
    padding: 1rem 1.5rem;
  }
  /* Profiles Finder */
  #finder-list {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .finder-card {
    background: #fff;
    border: 1px solid #e5e5e5;
    border-radius: 15px;
    padding: 1rem;
    width: calc(50% - 1rem);
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(233,30,99,0.15);
    display: flex;
    gap: 1rem;
    align-items: center;
    transition: box-shadow 0.3s ease;
  }
  .finder-card:hover {
    box-shadow: 0 6px 16px rgba(233,30,99,0.3);
    background: #fff0f6;
  }
  .finder-photo {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background-color: #f8bbd0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    font-size: 1.5rem;
    flex-shrink: 0;
    user-select: none;
    overflow: hidden;
  }
  .finder-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .finder-info {
    flex: 1;
  }
  .finder-info h3 {
    font-weight: 600;
    font-size: 1.2rem;
    color: #d81b60;
  }
  .finder-info p {
    font-size: 0.9rem;
    color: #555;
    margin-top: 0.15rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  /* Messages Chat */
  #messages-chat {
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  #messages-header {
    font-weight: 700;
    font-size: 1.3rem;
    color: #b71c46;
    border-bottom: 1px solid #ddd;
    padding-bottom: 0.6rem;
    margin-bottom: 0.7rem;
    text-align: center;
  }
  #messages-list {
    flex: 1;
    overflow-y: auto;
    padding-right: 0.5rem;
  }
  .message {
    margin-bottom: 0.6rem;
    padding: 0.5rem 0.8rem;
    border-radius: 15px;
    max-width: 75%;
    line-height: 1.2rem;
    word-wrap: break-word;
    font-size: 0.9rem;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    white-space: pre-wrap;
    position: relative;
  }
  .message.sent {
    background: #fce4ec;
    margin-left: auto;
    color: #880e4f;
  }
  .message.received {
    background: #ffcdd2;
    color: #4a0c2a;
  }
  .message.chatbot {
    background: #e1bee7;
    color: #4a148c;
    font-style: italic;
  }
  #message-input-form {
    display: flex;
    margin-top: 0.6rem;
    gap: 0.5rem;
  }
  #message-input {
    flex: 1;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    border: 1px solid #b71c46;
    outline: none;
    font-size: 1rem;
    font-family: 'Poppins', sans-serif;
    transition: border-color 0.3s ease;
  }
  #message-input:focus {
    border-color: #e91e63;
  }
  #send-message-btn {
    background: #e91e63;
    border: none;
    color: white;
    padding: 0 1.3rem;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    transition: background 0.3s ease;
  }
  #send-message-btn:disabled {
    background: #f48fb1;
    cursor: not-allowed;
  }
  #send-message-btn:hover:enabled {
    background: #ad1457;
  }
  /* Settings */
  #settings-form {
    max-width: 400px;
    margin: 0 auto;
  }
  #settings-form label {
    font-weight: 600;
    margin-bottom: 0.3rem;
    color: #b71c46;
    display: block;
  }
  #settings-form input[type="text"],
  #settings-form input[type="number"],
  #settings-form select,
  #settings-form textarea {
    width: 100%;
    padding: 0.5rem 0.7rem;
    border-radius: 10px;
    border: 1px solid #ccc;
    margin-bottom: 1rem;
    font-size: 1rem;
    font-family: 'Poppins', sans-serif;
    resize: vertical;
  }
  #settings-form textarea {
    min-height: 60px;
  }
  #settings-form button {
    background: #e91e63;
    border: none;
    color: white;
    padding: 0.7rem 1.2rem;
    border-radius: 25px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s ease;
    margin-top: 0.4rem;
  }
  #settings-form button:hover {
    background: #ad1457;
  }
  #image-preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 1rem;
  }
  .image-preview {
    width: 80px;
    height: 80px;
    border-radius: 15px;
    object-fit: cover;
    border: 2px solid #e91e63;
    box-shadow: 0 2px 4px rgba(233,30,99,0.3);
  }
  /* Credits & Logout panel */
  #sidebar-info {
    max-width: 260px;
    background: #fff0f5;
    border-right: 1px solid #ddd;
    padding: 1rem;
    box-sizing: border-box;
  }
  #credits-display {
    background: #fce4ec;
    padding: 0.6rem 1rem;
    border-radius: 20px;
    font-weight: 700;
    color: #c2185b;
    margin-bottom: 1rem;
    text-align: center;
    box-shadow: inset 0 0 5px #f8bbd0;
    user-select: none;
  }
  #buy-credits-btn, #logout-btn {
    width: 100%;
    border: none;
    cursor: pointer;
    font-weight: 600;
    border-radius: 20px;
    padding: 0.6rem 1rem;
    margin-bottom: 1rem;
    transition: background 0.3s ease;
    font-family: 'Poppins', sans-serif;
  }
  #buy-credits-btn {
    background: #e91e63;
    color: white;
  }
  #buy-credits-btn:hover {
    background: #ad1457;
  }
  #logout-btn {
    background: #ddd;
    color: #555;
    border-radius: 15px;
  }
  #logout-btn:hover {
    background: #ccc;
  }
  /* Locals Near Me section */
  #locals-near-me-section {
    margin-top: 1.5rem;
    border-top: 2px solid #e91e63;
    padding-top: 1rem;
  }
  #locate-btn {
    background: #b71c46;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 0.5rem 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
    margin-bottom: 1rem;
  }
  #locate-btn:hover:not(:disabled) {
    background: #7b0e2a;
  }
  #locals-message {
    color: #b71c46;
    font-style: italic;
    margin-bottom: 1rem;
  }
  /* Modals */
  .modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .modal-content {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    position: relative;
    text-align: center;
  }
  .close-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.8rem;
    background: transparent;
    color: #b71c46;
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    border: none;
  }
  #registration-form label,
  #login-form label,
  #signup-gender-label,
  #signup-attracted-to-label {
    text-align: left;
    display: block;
    font-weight: 600;
    margin-bottom: 0.2rem;
    color: #b71c46;
  }
  #registration-form input,
  #login-form input,
  #buy-credits-form select,
  #buy-credits-form input,
  #settings-form select {
    width: 100%;
    padding: 0.5rem 0.7rem;
    border-radius: 10px;
    border: 1px solid #ccc;
    margin-bottom: 1rem;
    font-size: 1rem;
    font-family: 'Poppins', sans-serif;
  }
  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }
  ::-webkit-scrollbar-thumb {
    background: #e91e63;
    border-radius: 10px;
  }
  /* Responsive */
  @media (max-width: 960px) {
    #finder-list .finder-card {
      width: 100%;
    }
    #app-container {
      max-width: 100%;
      height: 100vh;
      border-radius: 0;
      margin: 0;
      box-shadow: none;
    }
  }
  @media (max-width: 700px) {
    #main-body {
      flex-direction: column;
    }
    #sidebar-info {
      max-width: 100%;
      border-right: none;
      border-bottom: 1px solid #ddd;
      display: flex;
      gap: 1rem;
      padding: 0.7rem;
      justify-content: center;
    }
    #credits-display {
      margin-bottom: 0;
      flex: 1;
      line-height: 2.2;
      font-size: 1.1rem;
    }
    #buy-credits-btn, #logout-btn {
      width: auto;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
  }
</style>
</head>
<body>
  <div id="app-container" aria-live="polite">
    <header><span class="logo">‚ù§LoveConnect</span></header>
    <!-- Signup/Login Views -->
    <div id="signup-view" class="modal" role="dialog" aria-modal="true" aria-labelledby="signup-title" aria-hidden="false" style="display:flex;">
      <div class="modal-content">
        <h2 id="signup-title" style="color:#e91e63;margin-bottom:1rem;">Join LoveConnect</h2>
        <form id="registration-form" novalidate>
          <label for="reg-username">Username *</label>
          <input type="text" id="reg-username" name="reg-username" required minlength="3" autocomplete="username" />
          <label for="reg-email">Email *</label>
          <input type="email" id="reg-email" name="reg-email" required autocomplete="email" />
          <label for="reg-password">Password *</label>
          <input type="password" id="reg-password" name="reg-password" required minlength="6" autocomplete="new-password" />
          <label for="reg-password-confirm">Confirm Password *</label>
          <input type="password" id="reg-password-confirm" name="reg-password-confirm" required minlength="6" autocomplete="new-password" />

          <label id="signup-gender-label" for="reg-gender">Your Gender *</label>
          <select id="reg-gender" name="reg-gender" required>
            <option value="" disabled selected>Select your gender</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
          </select>

          <label id="signup-attracted-to-label" for="reg-attracted-to">Interested In *</label>
          <select id="reg-attracted-to" name="reg-attracted-to" required>
            <option value="" disabled selected>Select gender(s) you're attracted to</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
            <option value="all">All</option>
          </select>

          <button type="submit">Sign Up</button>
        </form>
        <p style="margin-top:1rem; font-size:0.9rem;">Already have an account? <button id="to-login-btn" style="color:#e91e63; background:none; border:none; cursor:pointer; font-weight:600;">Log In</button></p>
      </div>
    </div>

    <div id="login-view" class="modal" role="dialog" aria-modal="true" aria-labelledby="login-title" aria-hidden="true" style="display:none;">
      <div class="modal-content">
        <h2 id="login-title" style="color:#e91e63;margin-bottom:1rem;">Welcome Back!</h2>
        <form id="login-form" novalidate>
          <label for="login-email">Email *</label>
          <input type="email" id="login-email" name="login-email" required autocomplete="username" />
          <label for="login-password">Password *</label>
          <input type="password" id="login-password" name="login-password" required autocomplete="current-password" />
          <button type="submit">Log In</button>
        </form>
        <p style="margin-top:1rem; font-size:0.9rem;">Don't have an account? <button id="to-signup-btn" style="color:#e91e63; background:none; border:none; cursor:pointer; font-weight:600;">Sign Up</button></p>
      </div>
    </div>

    <!-- Main app content, initially hidden until login -->
    <div id="main-view" style="display:none; height: 100%; flex-direction: column;">

      <div id="tabs" role="tablist" aria-label="Main navigation tabs">
        <button class="tab-button active" role="tab" aria-selected="true" aria-controls="tab-messages" id="tabbtn-messages">Messages</button>
        <button class="tab-button" role="tab" aria-selected="false" aria-controls="tab-finder" id="tabbtn-finder">Finder</button>
        <button class="tab-button" role="tab" aria-selected="false" aria-controls="tab-settings" id="tabbtn-settings">Settings</button>
      </div>

      <div id="main-body" style="flex:1; display:flex; min-height:0;">
        <aside id="sidebar-info" aria-label="User info and actions">
          <h2 id="current-user-name" aria-live="polite" style="color:#e91e63; font-weight:700; margin-bottom:0.8rem;">Hello!</h2>
          <div id="credits-display" aria-live="polite">Credits: 0</div>
          <button id="buy-credits-btn" aria-label="Buy more credits">Buy Credits</button>
          <button id="logout-btn" aria-label="Logout from account">Logout</button>
        </aside>

        <section id="tab-messages" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-messages" style="display:flex; flex-direction: column;">
          <div id="messages-chat">
            <div id="messages-header">Select a profile to chat</div>
            <div id="messages-list" tabindex="0" aria-live="polite" aria-relevant="additions"></div>
            <form id="message-input-form" style="display:none;" aria-label="Send message form">
              <input id="message-input" type="text" placeholder="Type a message..." autocomplete="off" aria-required="true" />
              <button id="send-message-btn" type="submit" disabled>Send</button>
            </form>
          </div>
        </section>

        <section id="tab-finder" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-finder" style="display:none;">
          <h2 style="color:#e91e63; font-weight:700; margin-bottom:1rem;">Find Profiles</h2>
          <div>
            <button id="locate-btn" aria-label="Locate profiles near me">Find Locals Near Me</button>
            <div id="locals-message"></div>
          </div>
          <div id="finder-list" role="list" aria-live="polite" aria-label="List of profiles"></div>
        </section>

        <section id="tab-settings" class="tab-panel" role="tabpanel" aria-labelledby="tabbtn-settings" style="display:none;">
          <h2 style="color:#e91e63; font-weight:700; margin-bottom:1rem;">Settings</h2>
          <form id="settings-form" aria-label="Profile customization form">
            <label for="settings-name">Name *</label>
            <input type="text" id="settings-name" name="settings-name" required minlength="2" autocomplete="name" />
            <label for="settings-age">Age *</label>
            <input type="number" id="settings-age" name="settings-age" min="18" max="120" required />
            <label for="settings-bio">Bio (optional)</label>
            <textarea id="settings-bio" name="settings-bio" maxlength="150" placeholder="Tell something about yourself..."></textarea>
            <label for="settings-state">State *</label>
            <select id="settings-state" name="settings-state" required>
              <option value="" disabled selected>Select your state</option>
            </select>
            <label for="settings-images">Upload Images (max 5)</label>
            <input type="file" id="settings-images" name="settings-images" accept="image/*" multiple />
            <div id="image-preview-container"></div>
            <button type="submit">Save Changes</button>
          </form>
        </section>
      </div>
    </div>

    <!-- Buy Credits Modal -->
    <div id="credits-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="credits-modal-title" style="display:none;">
      <div class="modal-content">
        <button class="close-btn" id="credits-modal-close" title="Close buy credits">&times;</button>
        <h2 id="credits-modal-title" style="color:#e91e63;margin-bottom:1rem;">Buy Credits</h2>
        <form id="buy-credits-form">
          <label for="credit-package">Select Package</label>
          <select id="credit-package" required>
            <option value="" disabled selected>Select an amount</option>
            <option value="5">5 Credits - $5</option>
            <option value="10">10 Credits - $9</option>
            <option value="25">25 Credits - $20</option>
            <option value="50">50 Credits - $35</option>
          </select>
          <label for="payment-method">Payment Method</label>
          <select id="payment-method" required>
            <option value="" disabled selected>Select payment method</option>
            <option value="card">Credit/Debit Card</option>
            <option value="ltc">Litecoin (LTC)</option>
          </select>

          <div id="card-details" style="display:none; margin-top:1rem; text-align:left;">
            <label for="card-number">Card Number</label>
            <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" autocomplete="cc-number" />
            <label for="card-expiry">Expiry (MM/YY)</label>
            <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5" autocomplete="cc-exp" />
            <label for="card-cvc">CVC</label>
            <input type="text" id="card-cvc" placeholder="123" maxlength="4" autocomplete="cc-csc" />
          </div>

          <div id="ltc-details" style="display:none; margin-top:1rem; text-align:left;">
            <p>Send Litecoin (LTC) to address:</p>
            <p><code>Lc27mFwXYPnZzLZZNm19TZxUyptkBjx123</code></p>
            <p>After payment, click confirm to add credits.</p>
          </div>

          <button type="submit" style="margin-top:1rem;">Confirm Purchase</button>
        </form>
        <div id="purchase-status" style="margin-top:1rem; color:#c2185b; font-weight:600;"></div>
      </div>
    </div>

  </div>

<script>
  // US states with approximate lat/lon (capital coords)
  const US_STATES_COORDS = {
    "Alabama": {lat:32.377716, lon:-86.300568},
    "Alaska": {lat:58.301598, lon:-134.420212},
    "Arizona": {lat:33.448143, lon:-112.096962},
    "Arkansas": {lat:34.746613, lon:-92.288986},
    "California": {lat:38.576668, lon:-121.493629},
    "Colorado": {lat:39.739227, lon:-104.984856},
    "Connecticut": {lat:41.764046, lon:-72.682198},
    "Delaware": {lat:39.157307, lon:-75.519722},
    "Florida": {lat:30.438118, lon:-84.281296},
    "Georgia": {lat:33.749027, lon:-84.388229},
    "Hawaii": {lat:21.307442, lon:-157.857376},
    "Idaho": {lat:43.617775, lon:-116.199722},
    "Illinois": {lat:39.798363, lon:-89.654961},
    "Indiana": {lat:39.768623, lon:-86.162643},
    "Iowa": {lat:41.591087, lon:-93.603729},
    "Kansas": {lat:39.048191, lon:-95.677956},
    "Kentucky": {lat:38.186722, lon:-84.875374},
    "Louisiana": {lat:30.457069, lon:-91.187393},
    "Maine": {lat:44.307167, lon:-69.781693},
    "Maryland": {lat:38.978764, lon:-76.490936},
    "Massachusetts": {lat:42.358162, lon:-71.063698},
    "Michigan": {lat:42.733635, lon:-84.555328},
    "Minnesota": {lat:44.955097, lon:-93.102211},
    "Mississippi": {lat:32.303848, lon:-90.182106},
    "Missouri": {lat:38.579201, lon:-92.172935},
    "Montana": {lat:46.585709, lon:-112.018417},
    "Nebraska": {lat:40.808075, lon:-96.699654},
    "Nevada": {lat:39.163914, lon:-119.766121},
    "New Hampshire": {lat:43.206898, lon:-71.537994},
    "New Jersey": {lat:40.220596, lon:-74.769913},
    "New Mexico": {lat:35.68224, lon:-105.939728},
    "New York": {lat:42.652843, lon:-73.757874},
    "North Carolina": {lat:35.78043, lon:-78.639099},
    "North Dakota": {lat:46.82085, lon:-100.783318},
    "Ohio": {lat:39.961346, lon:-82.999069},
    "Oklahoma": {lat:35.492207, lon:-97.503342},
    "Oregon": {lat:44.938461, lon:-123.030403},
    "Pennsylvania": {lat:40.264378, lon:-76.883598},
    "Rhode Island": {lat:41.830914, lon:-71.414963},
    "South Carolina": {lat:34.000343, lon:-81.033211},
    "South Dakota": {lat:44.367031, lon:-100.346405},
    "Tennessee": {lat:36.16581, lon:-86.784241},
    "Texas": {lat:30.27467, lon:-97.740349},
    "Utah": {lat:40.777477, lon:-111.888237},
    "Vermont": {lat:44.262436, lon:-72.580536},
    "Virginia": {lat:37.538857, lon:-77.43364},
    "Washington": {lat:47.035805, lon:-122.905014},
    "West Virginia": {lat:38.336246, lon:-81.612328},
    "Wisconsin": {lat:43.074684, lon:-89.384445},
    "Wyoming": {lat:41.140259, lon:-104.820236}
  };

  // Storage keys and app state
  const STORAGE_KEY_USERS = 'loveconnect_users';
  const STORAGE_KEY_CURRENT_USER = 'loveconnect_current_user';
  const STORAGE_KEY_MESSAGES = 'loveconnect_messages';

  // App State
  let users = [];
  let currentUser = null;
  let selectedChatUserId = null;
  let messages = [];
  let nearbyList = [];

  // DOM Elements
  const signupView = document.getElementById('signup-view');
  const loginView = document.getElementById('login-view');
  const mainView = document.getElementById('main-view');

  // Registration elements
  const registrationForm = document.getElementById('registration-form');
  const toLoginBtn = document.getElementById('to-login-btn');

  // Login elements
  const loginForm = document.getElementById('login-form');
  const toSignupBtn = document.getElementById('to-signup-btn');

  // Tabs
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabPanels = {
    messages: document.getElementById('tab-messages'),
    finder: document.getElementById('tab-finder'),
    settings: document.getElementById('tab-settings'),
  };

  // Sidebar info & buttons
  const userNameDisplay = document.getElementById('current-user-name');
  const creditsDisplay = document.getElementById('credits-display');
  const buyCreditsBtn = document.getElementById('buy-credits-btn');
  const logoutBtn = document.getElementById('logout-btn');

  // Finder
  const finderList = document.getElementById('finder-list');
  const locateBtn = document.getElementById('locate-btn');
  const localsMessage = document.getElementById('locals-message');

  // Chat
  const messagesHeader = document.getElementById('messages-header');
  const messagesList = document.getElementById('messages-list');
  const messageInputForm = document.getElementById('message-input-form');
  const messageInput = document.getElementById('message-input');
  const sendMessageBtn = document.getElementById('send-message-btn');

  // Settings form
  const settingsForm = document.getElementById('settings-form');
  const settingsName = document.getElementById('settings-name');
  const settingsAge = document.getElementById('settings-age');
  const settingsBio = document.getElementById('settings-bio');
  const settingsState = document.getElementById('settings-state');
  const settingsImages = document.getElementById('settings-images');
  const imagePreviewContainer = document.getElementById('image-preview-container');

  // Credit purchase modal elements
  const creditsModal = document.getElementById('credits-modal');
  const creditsModalClose = document.getElementById('credits-modal-close');
  const buyCreditsForm = document.getElementById('buy-credits-form');
  const creditPackageSelect = document.getElementById('credit-package');
  const paymentMethodSelect = document.getElementById('payment-method');
  const cardDetails = document.getElementById('card-details');
  const ltcDetails = document.getElementById('ltc-details');
  const purchaseStatus = document.getElementById('purchase-status');
  const cardNumberInput = document.getElementById('card-number');
  const cardExpiryInput = document.getElementById('card-expiry');
  const cardCvcInput = document.getElementById('card-cvc');

  // Utilities

  function saveUsers(){
    localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
  }

  function saveCurrentUser(){
    localStorage.setItem(STORAGE_KEY_CURRENT_USER, currentUser ? currentUser.id : '');
  }

  function saveMessages(){
    localStorage.setItem(STORAGE_KEY_MESSAGES, JSON.stringify(messages));
  }

  function loadUsers(){
    const usersData = localStorage.getItem(STORAGE_KEY_USERS);
    users = usersData ? JSON.parse(usersData) : [];
  }

  function loadCurrentUser(){
    const userId = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
    if(userId){
      currentUser = users.find(u => u.id === userId) || null;
    } else {
      currentUser = null;
    }
  }

  function loadMessages(){
    const messagesData = localStorage.getItem(STORAGE_KEY_MESSAGES);
    messages = messagesData ? JSON.parse(messagesData) : [];
  }

  function generateUserId(){
    return 'user_' + Date.now() + '_' + Math.floor(Math.random()*1000);
  }

  function createUser(username, email, password, gender, attractedTo){
    return {
      id: generateUserId(),
      name: username.trim(),
      email: email.trim(),
      password: password, // plain text in demo (insecure)
      credits: 10,
      age: 25,
      bio: '',
      gender,
      attractedTo,
      state: '',
      images: [],
      lat: null,
      lon: null
    };
  }

  // Populate state select in settings
  function populateStateSelect(){
    settingsState.innerHTML = '<option value="" disabled>Select your state</option>';
    Object.keys(US_STATES_COORDS).sort().forEach(state=>{
      const opt = document.createElement('option');
      opt.value = state;
      opt.textContent = state;
      settingsState.appendChild(opt);
    });
  }

  // UI helpers

  function switchView(view){
    signupView.style.display = 'none';
    signupView.setAttribute('aria-hidden', 'true');
    loginView.style.display = 'none';
    loginView.setAttribute('aria-hidden', 'true');
    mainView.style.display = 'none';
    if(view === 'signup'){
      signupView.style.display = 'flex';
      signupView.setAttribute('aria-hidden', 'false');
      registrationForm.querySelector('input').focus();
    } else if(view === 'login') {
      loginView.style.display = 'flex';
      loginView.setAttribute('aria-hidden', 'false');
      loginForm.querySelector('input').focus();
    } else if(view === 'main') {
      mainView.style.display = 'flex';
      tabButtons[0].focus();
    }
  }

  function updateUI(){
    if(currentUser){
      userNameDisplay.textContent = `Hello, ${currentUser.name}!`;
      creditsDisplay.textContent = `Credits: ${currentUser.credits}`;
      renderFinderList();
      clearMessagesPanel();
      loadSettingsToForm();
      renderImagePreviews();
    } else {
      userNameDisplay.textContent = 'Hello!';
      creditsDisplay.textContent = 'Credits: 0';
      finderList.innerHTML = '<p style="color:#888;">No user logged in.</p>';
      clearMessagesPanel();
    }
  }

  // Tab navigation
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      activateTab(btn.id);
    });
  });

  function activateTab(tabBtnId){
    tabButtons.forEach(btn => {
      const inTabName = btn.id.replace('tabbtn-', '');
      const panel = tabPanels[inTabName];

      if(btn.id === tabBtnId){
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');
        panel.style.display = 'block';
      } else {
        btn.classList.remove('active');
        btn.setAttribute('aria-selected', 'false');
        panel.style.display = 'none';
      }
    });

    if(tabBtnId === 'tabbtn-messages' && selectedChatUserId){
      renderMessages();
    }
  }

  // Finder tab - list profiles filtered by gender attraction and state (for near me)
  function renderFinderList(profiles = null){
    finderList.innerHTML = '';
    let others = profiles || users.filter(u => u.id !== currentUser.id && u.id !== 'bot_welcome');
    // Filter based on mutual attraction
    others = others.filter(other => {
      if(!other.gender || !other.attractedTo) return false;
      // Current user's attractedTo includes other's gender, and other attractedTo includes current user's gender
      if(currentUser.attractedTo === 'all' || currentUser.attractedTo === other.gender){
        if(other.attractedTo === 'all' || other.attractedTo === currentUser.gender){
          return true;
        }
      }
      return false;
    });
    if(others.length === 0){
      finderList.innerHTML = '<p style="color:#888;">No matching profiles found.</p>';
      return;
    }
    others.forEach(user => {
      const card = document.createElement('div');
      card.className = 'finder-card';
      card.tabIndex = 0;
      card.setAttribute('role', 'listitem');
      card.dataset.userid = user.id;

      const photoDiv = document.createElement('div');
      photoDiv.className = 'finder-photo';
      if(user.images && user.images.length > 0){
        const img = document.createElement('img');
        img.src = user.images[0];
        img.alt = `${user.name}'s profile photo`;
        photoDiv.appendChild(img);
      } else {
        const initials = user.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
        photoDiv.textContent = initials;
      }

      const infoDiv = document.createElement('div');
      infoDiv.className = 'finder-info';

      const nameH3 = document.createElement('h3');
      nameH3.textContent = user.name;

      const bioP = document.createElement('p');
      let bioText = user.bio ? user.bio : `Age: ${user.age}`;
      if(user.state) bioText += ` | ${user.state}`;
      bioP.textContent = bioText;

      infoDiv.appendChild(nameH3);
      infoDiv.appendChild(bioP);

      card.appendChild(photoDiv);
      card.appendChild(infoDiv);

      card.addEventListener('click', () => {
        activateTab('tabbtn-messages');
        selectChatUser(user.id);
      });
      card.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          activateTab('tabbtn-messages');
          selectChatUser(user.id);
        }
      });

      finderList.appendChild(card);
    });
  }

  // Messages tab
  function clearMessagesPanel(){
    selectedChatUserId = null;
    messagesHeader.textContent = 'Select a profile to chat';
    messagesList.innerHTML = '';
    messageInputForm.style.display = 'none';
  }

  function selectChatUser(userId){
    selectedChatUserId = userId;
    const user = users.find(u => u.id === userId);
    messagesHeader.textContent = `Chat with ${user.name}`;
    renderMessages();
    messageInputForm.style.display = 'flex';
    messageInput.value = '';
    sendMessageBtn.disabled = true;
    messageInput.focus();
  }

  function renderMessages(){
    messagesList.innerHTML = '';
    if(!selectedChatUserId) return;
    const chatMessages = messages.filter(m =>
      (m.from === currentUser.id && m.to === selectedChatUserId) ||
      (m.from === selectedChatUserId && m.to === currentUser.id)
    );
    chatMessages.forEach(m=>{
      const msgDiv = document.createElement('div');
      if(m.from === 'bot_welcome'){
        msgDiv.className = 'message chatbot';
        msgDiv.textContent = m.text;
      } else if(m.from === currentUser.id){
        msgDiv.className = 'message sent';
        msgDiv.textContent = m.text;
      } else {
        msgDiv.className = 'message received';
        msgDiv.textContent = m.text;
      }
      messagesList.appendChild(msgDiv);
    });
    messagesList.scrollTop = messagesList.scrollHeight;
  }

  // Messaging handlers
  messageInput.addEventListener('input', () => {
    sendMessageBtn.disabled = messageInput.value.trim().length === 0;
  });

  messageInputForm.addEventListener('submit', e => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if(!text) return;

    if(!selectedChatUserId) return;

    if(selectedChatUserId === 'bot_welcome'){
      alert('The chatbot is not available for messaging.');
      messageInput.value = '';
      sendMessageBtn.disabled = true;
      return;
    }

    if(currentUser.credits < 1){
      alert('You do not have enough credits to send a message. Please buy more credits.');
      return;
    }
    currentUser.credits -= 1;
    creditsDisplay.textContent = `Credits: ${currentUser.credits}`;
    saveUsers();

    messages.push({from: currentUser.id, to: selectedChatUserId, text: text, timestamp: Date.now()});
    saveMessages();

    renderMessages();

    messageInput.value = '';
    sendMessageBtn.disabled = true;
  });

  // Settings tab handlers
  function loadSettingsToForm(){
    settingsName.value = currentUser.name || '';
    settingsAge.value = currentUser.age || 25;
    settingsBio.value = currentUser.bio || '';
    settingsState.value = currentUser.state || '';
    renderImagePreviews();
  }

  settingsForm.addEventListener('submit', e => {
    e.preventDefault();
    const newName = settingsName.value.trim();
    const newAge = parseInt(settingsAge.value);
    const newBio = settingsBio.value.trim();
    const newState = settingsState.value;

    if(newName.length < 2){
      alert('Name must be at least 2 characters.');
      return;
    }
    if(isNaN(newAge) || newAge < 18 || newAge > 120){
      alert('Please enter a valid age (18-120).');
      return;
    }
    if(!newState || !(newState in US_STATES_COORDS)){
      alert('Please select a valid state.');
      return;
    }

    currentUser.name = newName;
    currentUser.age = newAge;
    currentUser.bio = newBio;
    currentUser.state = newState;

    // Update lat/lon for user from US_STATES_COORDS map
    let loc = US_STATES_COORDS[newState];
    if(loc){
      currentUser.lat = loc.lat;
      currentUser.lon = loc.lon;
    } else {
      currentUser.lat = null;
      currentUser.lon = null;
    }

    saveUsers();
    updateUI();
    alert('Profile updated successfully!');
  });

  // Image upload handling
  settingsImages.addEventListener('change', e=>{
    const files = Array.from(e.target.files);
    if((currentUser.images.length + files.length) > 5){
      alert('You can upload max 5 images.');
      return;
    }
    const readers = files.map(file=>{
      return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject('Error reading file');
        reader.readAsDataURL(file);
      });
    });
    Promise.all(readers).then(base64imgs=>{
      currentUser.images.push(...base64imgs);
      saveUsers();
      renderImagePreviews();
    });
    // Clear input for re-upload
    settingsImages.value = '';
  });

  // Render image previews
  function renderImagePreviews(){
    imagePreviewContainer.innerHTML = '';
    if(!currentUser.images || currentUser.images.length === 0){
      imagePreviewContainer.textContent = 'No images uploaded.';
      return;
    }
    currentUser.images.forEach((src, idx)=>{
      const img = document.createElement('img');
      img.src = src;
      img.className = 'image-preview';
      img.alt = 'Profile image '+(idx+1);

      // add delete on click
      img.title = 'Click to remove image';
      img.style.cursor = 'pointer';
      img.addEventListener('click', () => {
        if(confirm('Remove this image?')){
          currentUser.images.splice(idx, 1);
          saveUsers();
          renderImagePreviews();
        }
      });

      imagePreviewContainer.appendChild(img);
    });
  }

  // Credit purchase modal handlers
  buyCreditsBtn.addEventListener('click', ()=>{
    purchaseStatus.textContent = '';
    buyCreditsForm.reset();
    cardDetails.style.display = 'none';
    ltcDetails.style.display = 'none';
    creditsModal.style.display = 'flex';
  });

  creditsModalClose.addEventListener('click', () => {
    creditsModal.style.display = 'none';
  });

  paymentMethodSelect.addEventListener('change', () => {
    purchaseStatus.textContent = '';
    if(paymentMethodSelect.value === 'card'){
      cardDetails.style.display = 'block';
      ltcDetails.style.display = 'none';
    } else if(paymentMethodSelect.value === 'ltc'){
      cardDetails.style.display = 'none';
      ltcDetails.style.display = 'block';
    } else {
      cardDetails.style.display = 'none';
      ltcDetails.style.display = 'none';
    }
  });

  function validateCardDetails(){
    // Very simple validations
    const cardNum = cardNumberInput.value.trim().replace(/\s/g, '');
    const expiry = cardExpiryInput.value.trim();
    const cvc = cardCvcInput.value.trim();

    if(!/^\d{13,19}$/.test(cardNum)){
      return false;
    }
    if(!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiry)){
      return false;
    }
    if(!/^\d{3,4}$/.test(cvc)){
      return false;
    }
    return true;
  }

  buyCreditsForm.addEventListener('submit', e=>{
    e.preventDefault();
    purchaseStatus.style.color = '#c2185b';
    purchaseStatus.textContent = '';

    const packageValue = creditPackageSelect.value;
    const paymentMethod = paymentMethodSelect.value;

    if(!packageValue){
      purchaseStatus.textContent = 'Please select a credit package.';
      return;
    }
    if(!paymentMethod){
      purchaseStatus.textContent = 'Please select a payment method.';
      return;
    }

    if(paymentMethod === 'card'){
      if(!validateCardDetails()){
        purchaseStatus.textContent = 'Please enter valid card details.';
        return;
      }
      purchaseStatus.textContent = 'Processing card payment...';
      setTimeout(()=>{
        addCredits(parseInt(packageValue));
        purchaseStatus.style.color = 'green';
        purchaseStatus.textContent = `Payment successful! Added ${packageValue} credits.`;
        setTimeout(()=>creditsModal.style.display = 'none', 2000);
      },1800);
    } else if(paymentMethod === 'ltc'){
      purchaseStatus.textContent = 'Confirming Litecoin payment...';
      setTimeout(()=>{
        addCredits(parseInt(packageValue));
        purchaseStatus.style.color = 'green';
        purchaseStatus.textContent = `Litecoin payment confirmed! Added ${packageValue} credits.`;
        setTimeout(()=>creditsModal.style.display = 'none', 2000);
      },3000);
    }
  });

  function addCredits(amount){
    currentUser.credits += amount;
    creditsDisplay.textContent = `Credits: ${currentUser.credits}`;
    saveUsers();
  }

  // Logout
  logoutBtn.addEventListener('click', () => {
    if(confirm('Are you sure you want to logout?')){
      currentUser = null;
      selectedChatUserId = null;
      saveCurrentUser();
      switchView('login');
      updateUI();
    }
  });

  // Registration logic

  registrationForm.addEventListener('submit', e=>{
    e.preventDefault();
    const username = registrationForm['reg-username'].value.trim();
    const email = registrationForm['reg-email'].value.trim();
    const password = registrationForm['reg-password'].value;
    const passwordConfirm = registrationForm['reg-password-confirm'].value;
    const gender = registrationForm['reg-gender'].value;
    const attractedTo = registrationForm['reg-attracted-to'].value;

    if(username.length < 3){
      alert('Username must be at least 3 characters.');
      return;
    }
    if(!validateEmail(email)){
      alert('Please enter a valid email address.');
      return;
    }
    if(password.length < 6){
      alert('Password must be at least 6 characters.');
      return;
    }
    if(password !== passwordConfirm){
      alert('Passwords do not match.');
      return;
    }
    if(!gender){
      alert('Please select your gender.');
      return;
    }
    if(!attractedTo){
      alert('Please select the gender(s) you are attracted to.');
      return;
    }
    if(users.some(u => u.email.toLowerCase() === email.toLowerCase())){
      alert('This email is already registered.');
      return;
    }
    if(users.some(u => u.name.toLowerCase() === username.toLowerCase())){
      alert('This username is already taken.');
      return;
    }
    const newUser = createUser(username, email, password, gender, attractedTo);
    users.push(newUser);

    // Create chatbot user if missing
    if(!users.find(u=>u.id==='bot_welcome')){
      users.push({id:'bot_welcome', name:'LoveBot', email:null, password:null, credits:0, gender:'other', attractedTo:'all', state:'', images:[], lat:null, lon:null});
    }

    saveUsers();

    alert('Registration successful! You can now log in.');

    switchView('login');
  });

  toLoginBtn.addEventListener('click', () => switchView('login'));
  toSignupBtn.addEventListener('click', () => switchView('signup'));

  // Login logic
  loginForm.addEventListener('submit', e=>{
    e.preventDefault();
    const email = loginForm['login-email'].value.trim().toLowerCase();
    const password = loginForm['login-password'].value;

    const user = users.find(u=>u.email.toLowerCase() === email);

    if(!user){
      alert('No account found with that email.');
      return;
    }
    if(user.password !== password){
      alert('Incorrect password.');
      return;
    }

    currentUser = user;
    saveCurrentUser();

    switchView('main');
    updateUI();

    if(!sessionStorage.getItem('welcomed')){
      welcomeUserWithChatBot();
      sessionStorage.setItem('welcomed', 'true');
    }
  });

  // Email validation util
  function validateEmail(email){
    return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email);
  }

  // Chatbot welcome
  function welcomeUserWithChatBot(){
    const botId = 'bot_welcome';
    const existingBotMsgs = messages.filter(m => m.from === botId && m.to === currentUser.id);
    if(existingBotMsgs.length > 0) return;

    const botMessages = [
      {from: botId, to: currentUser.id, text: `Hello ${currentUser.name}! Welcome to LoveConnect! ‚ù§`},
      {from: botId, to: currentUser.id, text: `You have 10 free credits to send messages. Each message costs 1 credit.`},
      {from: botId, to: currentUser.id, text: `Feel free to browse profiles and start dating! üòä`}
    ];
    messages = messages.concat(botMessages);
    saveMessages();

    activateTab('tabbtn-messages');
    selectChatUser(botId);
  }

  // Basic keyboard ESC close handling for modals (credits)
  window.addEventListener('keydown', e => {
    if(e.key === 'Escape'){
      if(creditsModal.style.display === 'flex'){
        creditsModal.style.display = 'none';
      }
    }
  });

  // Geolocation helper function (Haversine formula)
  function distanceKm(lat1, lon1, lat2, lon2){
    const R = 6371; // Earth radius km
    const dLat = (lat2 - lat1)*Math.PI/180;
    const dLon = (lon2 - lon1)*Math.PI/180;
    const a = 
      Math.sin(dLat/2)*Math.sin(dLat/2) +
      Math.cos(lat1 * Math.PI/180)*Math.cos(lat2 * Math.PI/180) *
      Math.sin(dLon/2)*Math.sin(dLon/2);
    const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R*c;
  }

  // "Locals Near Me" functionality
  locateBtn.addEventListener('click', () => {
    if(!navigator.geolocation){
      localsMessage.textContent = 'Geolocation is not supported by your browser.';
      return;
    }
    localsMessage.textContent = 'Locating... Please grant location permission.';
    navigator.geolocation.getCurrentPosition(position => {
      localsMessage.textContent = `Location found! Sorting profiles by distance...`;
      const {latitude: lat1, longitude: lon1} = position.coords;

      // Save current user's lat/lon for better distance accuracy (override state lat/lon)
      currentUser.lat = lat1;
      currentUser.lon = lon1;
      saveUsers();

      // Filter others by mutual attraction
      const others = users.filter(u => u.id !== currentUser.id && u.id !== 'bot_welcome').filter(other => {
        if(!other.gender || !other.attractedTo) return false;
        if(currentUser.attractedTo === 'all' || currentUser.attractedTo === other.gender){
          if(other.attractedTo === 'all' || other.attractedTo === currentUser.gender){
            return true;
          }
        }
        return false;
      });

      const usersWithDistance = others.map(u => {
        let lat2 = u.lat;
        let lon2 = u.lon;
        if(lat2 == null || lon2 == null){
          // If no lat/lon saved for user, try state coords
          if(u.state && US_STATES_COORDS[u.state]){
            lat2 = US_STATES_COORDS[u.state].lat;
            lon2 = US_STATES_COORDS[u.state].lon;
          } else {
            lat2 = null;
            lon2 = null;
          }
        }
        let dist = null;
        if(lat2 !== null && lon2 !== null){
          dist = distanceKm(lat1, lon1, lat2, lon2);
        }
        return {...u, distance: dist};
      }).filter(u => u.distance !== null);

      // Sort ascending by distance
      usersWithDistance.sort((a,b) => a.distance - b.distance);

      nearbyList = usersWithDistance;

      // Render list under finder with distance info
      renderFinderListWithDistance(nearbyList);

      localsMessage.textContent = `Found ${usersWithDistance.length} local profiles nearby. Sorted by proximity.`;
    }, error => {
      if(error.code === error.PERMISSION_DENIED){
        localsMessage.textContent = 'Location access denied. Cannot find locals near you.';
      } else {
        localsMessage.textContent = 'Unable to determine location.';
      }
    },{
      enableHighAccuracy: true,
      timeout: 10000
    });
  });

  // Render finder list with distance
  function renderFinderListWithDistance(list){
    finderList.innerHTML = '';
    if(list.length === 0){
      finderList.innerHTML = '<p style="color:#888;">No local profiles found matching your preferences.</p>';
      return;
    }
    list.forEach(user => {
      const card = document.createElement('div');
      card.className = 'finder-card';
      card.tabIndex = 0;
      card.setAttribute('role', 'listitem');
      card.dataset.userid = user.id;

      const photoDiv = document.createElement('div');
      photoDiv.className = 'finder-photo';
      if(user.images && user.images.length > 0){
        const img = document.createElement('img');
        img.src = user.images[0];
        img.alt = `${user.name}'s profile photo`;
        photoDiv.appendChild(img);
      } else {
        const initials = user.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
        photoDiv.textContent = initials;
      }

      const infoDiv = document.createElement('div');
      infoDiv.className = 'finder-info';

      const nameH3 = document.createElement('h3');
      nameH3.textContent = user.name;

      const bioP = document.createElement('p');
      let bioText = user.bio ? user.bio : `Age: ${user.age}`;
      if(user.state) bioText += ` | ${user.state}`;
      if(user.distance != null){
        bioText += ` | ${user.distance.toFixed(1)} km away`;
      }
      bioP.textContent = bioText;

      infoDiv.appendChild(nameH3);
      infoDiv.appendChild(bioP);

      card.appendChild(photoDiv);
      card.appendChild(infoDiv);

      card.addEventListener('click', () => {
        activateTab('tabbtn-messages');
        selectChatUser(user.id);
      });
      card.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          activateTab('tabbtn-messages');
          selectChatUser(user.id);
        }
      });

      finderList.appendChild(card);
    });
  }

  // Initialize app
  function init(){
    loadUsers();
    loadCurrentUser();
    loadMessages();
    populateStateSelect();
    if(currentUser){
      switchView('main');
      updateUI();
    } else {
      switchView('signup');
    }
  }

  // Initialize
  init();

</script>
</body>
</html>

```
